name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  sdk-py:
    name: Python SDK
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: sdk-py
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Lint (ruff)
        run: uv run ruff check .

      - name: Type check (mypy)
        run: uv run mypy src/

      - name: Test (pytest)
        run: uv run pytest --tb=short

  server:
    name: Go Server
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: server

    services:
      clickhouse:
        image: clickhouse/clickhouse-server:24-alpine
        ports:
          - 9000:9000
          - 8123:8123
        options: >-
          --health-cmd "clickhouse-client --query 'SELECT 1'"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Resolve dependencies
        run: go mod tidy

      - name: Apply ClickHouse migrations
        run: |
          for f in ../migrations/clickhouse/*.sql; do
            clickhouse-client --host 127.0.0.1 --port 9000 --database default --multiquery < "$f"
          done

      - name: Vet
        run: go vet ./...

      - name: Build
        run: go build ./...

      - name: Test
        run: go test ./...
        env:
          CLICKHOUSE_HOST: 127.0.0.1
          CLICKHOUSE_PORT: 9000
          CLICKHOUSE_DATABASE: default
